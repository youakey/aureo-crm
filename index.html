<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aureo CRM</title>
  <style>
    body{font-family:system-ui;margin:16px;background:#0b0b0b;color:#fff}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    button,select{padding:10px 12px;border-radius:10px;border:1px solid #333;background:#151515;color:#fff}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #222;padding:10px;text-align:left;vertical-align:top}
    .pill{padding:4px 10px;border:1px solid #333;border-radius:999px;display:inline-block}
  </style>
</head>
<body>
  <div class="row">
    <button id="reload">Reload</button>
    <span id="status" class="pill">…</span>
  </div>

  <table id="tbl">
    <thead>
      <tr><th>ID</th><th>When</th><th>Name</th><th>Phone</th><th>Email</th><th>Message</th><th>Status</th><th>Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  alert("CRM LOADED " + new Date().toISOString());
  alert("tg=" + !!window.Telegram?.WebApp + " initDataLen=" + (window.Telegram?.WebApp?.initData || "").length);
  const workerBase = "https://aureo-leads.zerocppscript.workers.dev"; // <-- проверь

  function tg() {
    return window.Telegram?.WebApp;
  }
  function initData() {
    return tg()?.initData || "";
  }
  function tgInfo() {
    const t = tg();
    const userId = t?.initDataUnsafe?.user?.id || "-";
    return `tg:${!!t} initData:${(t?.initData||"").length} user:${userId}`;
  }

  async function api(path, opts = {}) {
    const r = await fetch(workerBase + path, {
      ...opts,
      headers: {
        ...(opts.headers || {}),
        "X-TG-INITDATA": initData(),
        "Content-Type": "application/json",
      },
    });
    return r.json();
  }

  async function load() {
    const statusEl = document.getElementById("status");
    statusEl.textContent = `Loading… | ${tgInfo()}`;

    const j = await api("/api/leads");

    if (!j.ok) {
      statusEl.textContent = `Unauthorized | ${tgInfo()}`;
      return;
    }

    statusEl.textContent = `OK | ${tgInfo()}`;

    const tb = document.querySelector("#tbl tbody");
    tb.innerHTML = "";
    for (const l of j.leads) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>#${l.id}</td>
        <td>${l.created_at}</td>
        <td>${esc(l.name)}</td>
        <td>${esc(l.phone)}</td>
        <td>${esc(l.email)}</td>
        <td>${esc(l.message)}</td>
        <td>${esc(l.status)}</td>
        <td>
          <button data-id="${l.id}" data-st="new">New</button>
          <button data-id="${l.id}" data-st="done">Done</button>
        </td>`;
      tb.appendChild(tr);
    }
  }

  function esc(s) {
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  document.getElementById("reload").onclick = load;
  document.addEventListener("click", async (e) => {
    const b = e.target.closest("button[data-id]");
    if (!b) return;
    const id = b.getAttribute("data-id");
    const st = b.getAttribute("data-st");
    await api("/api/lead/" + id, { method: "POST", body: JSON.stringify({ status: st }) });
    await load();
  });

  if (window.Telegram?.WebApp) window.Telegram.WebApp.ready();
  load();
</script>
</body>
</html>
